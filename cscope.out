cscope 15 /nobackup/chagoyal/multicast_server_client -q 0000000409 0000035575
	@client.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<”ºo.h
>

5 
	~<¡ršg.h
>

6 
	~<Ãtdb.h
>

7 
	~<sys/ty³s.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<sys/sock‘.h
>

10 
	~<¬·/š‘.h
>

11 
	~<sigÇl.h
>

12 
	~<±h»ad.h
>

14 
	~"commÚ_hdr.h
"

15 
	~"commÚ_uts.h
"

16 
	~"ş›Á_pkt_hªdËrs.h
"

20 
	gsockfd
;

21 
	gbusy_¡©e
;

22 
±h»ad_t
 
	gş›Á_»cv_th»ad
;

24 
±h»ad_t
 
	gş›Á_h—¹b—t_th»ad
;

27 *
g‘_š_addr
(
sockaddr
 *
§
);

28 
sigšt_hªdËr
(
s
);

29 
š™_sigÇl_hªdËr
();

30 
š™_sock‘
(
¬gc
, *
¬gv
[]);

31 
š™_ş›Á_»cv_th»ad
();

33 
š™_ş›Á_h—¹b—t_th»ad
();

35 
još_g½s
(*
g½_li¡
, 
g½_li¡_Ën
);

38 
	$maš
(
¬gc
, *
¬gv
[])

40 
numby‹s
;

41 
buf
[
MAXBUFFER
];

43 *
g½_li¡
;

44 
g½_li¡_Ën
;

46 
	`š™_sigÇl_hªdËr
();

48 
busy_¡©e
 = 
FALSE
;

50 ià(
	`š™_sock‘
(
¬gc
, 
¬gv
) != 0) {

51 
	`årštf
(
¡d”r
,"Unableo setup client (socket, bind,†isten)\n");

52 
	`ex™
(1);

55 
	`ut_g‘_št_li¡_äom_csv
(
¬gv
[3], &
g½_li¡
,

56 &
g½_li¡_Ën
);

58 
	`još_g½s
(
g½_li¡
, 
g½_li¡_Ën
);

61 
	`š™_ş›Á_»cv_th»ad
();

63 
	`š™_ş›Á_h—¹b—t_th»ad
();

66 
	`´štf
("Type‡ message. (Max 50 chars):\n");

67 
	`sÿnf
("%50s", 
buf
);

68 
numby‹s
 = 
	`pkt_£nd
(
sockfd
, 
MSG_HELLO
, 
buf
, 
	`¡¾’
(buf));

69 ià(-1 =ğ
numby‹s
) {

70 
	`³¼Ü
("send");

75 
	}
}

78 
	$još_g½s
(*
g½_li¡
, 
g½_li¡_Ën
)

81 
msg_još_g½_¶d
 *
¶d
;

82 
numby‹s
;

83 
i
;

85 
¶d
 = 
	`m®loc
((*pld));

86 
	`mem£t
(
¶d
, 0, (*pld));

88 ià(!
¶d
) {

89 
	`³¼Ü
("Ran out of memory!");

90 
	`ex™
(1);

94 
i
 = 0; i < 
g½_li¡_Ën
; i++) {

95 
	`´štf
("Joššg grou°%d\n", 
g½_li¡
[
i
]);

96 
¶d
->
g½_id
 = 
	`htÚs
(
g½_li¡
[
i
]);

97 
numby‹s
 = 
	`pkt_£nd
(
sockfd
, 
MSG_JOIN_GRP
,

98 
¶d
, (*pld));

99 ià(
numby‹s
 == -1) {

100 
	`´štf
("Error in sending MSG_JOIN_GRP");

105 
	`ä“
(
¶d
);

106 
	}
}

109 
	$š™_sock‘
(
¬gc
, *
¬gv
[])

111 
addršfo
 
hšts
, *
£rvšfo
, *
p
;

112 
s
[
INET6_ADDRSTRLEN
];

113 
rv
;

115 ià(
¬gc
 != 4) {

116 
	`årštf
(
¡d”r
,"usage: %s <server-port-num> <server-hostname>"

118 
¬gv
[0]);

122 
	`mem£t
(&
hšts
, 0,  hints);

123 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

124 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

125 ià((
rv
 = 
	`g‘addršfo
(
¬gv
[2],‡rgv[1], &
hšts
, &
£rvšfo
)) != 0) {

126 
	`årštf
(
¡d”r
, "g‘addršfo: %s\n", 
	`gai_¡»¼Ü
(
rv
));

131 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

132 ià((
sockfd
 = 
	`sock‘
(
p
->
ai_çmy
,…->
ai_sockty³
,…->
ai_´ÙocŞ
)) == -1) {

133 
	`³¼Ü
("client: socket");

136 ià(
	`cÚÃù
(
sockfd
, 
p
->
ai_addr
,…->
ai_add¾’
) == -1) {

137 
	`şo£
(
sockfd
);

138 
	`³¼Ü
("client: connect");

144 ià(
p
 =ğ
NULL
) {

145 
	`årštf
(
¡d”r
, "client: failedo connect\n");

148 
	`š‘_Áİ
(
p
->
ai_çmy
, 
	`g‘_š_addr
((
sockaddr
 *í->
ai_addr
), 
s
,  s);

149 
	`´štf
("ş›Á: cÚÃùšgØ%s\n", 
s
);

150 
	`ä“addršfo
(
£rvšfo
);

153 
	}
}

156 *
	$g‘_š_addr
(
sockaddr
 *
§
)

158 ià(
§
->
§_çmy
 =ğ
AF_INET
)

160  &(((
sockaddr_š
*)
§
)->
sš_addr
);

162  &(((
sockaddr_š6
*)
§
)->
sš6_addr
);

163 
	}
}

167 
	$sigšt_hªdËr
(
s
)

169 
	`pkt_£nd
(
sockfd
, 
MSG_QUIT
, 0, 0);

170 
	`şo£
(
sockfd
);

171 
	`´štf
("Thanks for„unninghe client. Exiting...\n");

172 
	`ex™
(0);

173 
	}
}

176 
	$š™_sigÇl_hªdËr
()

178 
sigaùiÚ
 
§
;

180 
	`sigem±y£t
(&
§
.
§_mask
);

181 
§
.
§_hªdËr
 = 
sigšt_hªdËr
;

182 ià(-1 =ğ
	`sigaùiÚ
(
SIGINT
, &
§
, 
NULL
)) {

183 
	`³¼Ü
("sigaction sigint");

184 
	`ex™
(1);

186 
	}
}

189 
	$š™_ş›Á_»cv_th»ad
()

191 
	`±h»ad_ü—‹
 (&
ş›Á_»cv_th»ad
, 
NULL
,

192 
ş›Á_»cv_th»ad_â
,

193 
NULL
);

194 
	}
}

197 
	$š™_ş›Á_h—¹b—t_th»ad
()

199 
	`±h»ad_ü—‹
 (&
ş›Á_h—¹b—t_th»ad
, 
NULL
,

200 
ş›Á_h—¹b—t_th»ad_â
,

201 
NULL
);

202 
	}
}

	@client.h

1 #iâdeà
_CLIENT_H


2 
	#_CLIENT_H


	)

4 
	~"commÚ_hdr.h
"

5 
busy_¡©e
;

6 
sockfd
;

	@client_pkt_handlers.c

1 
	~"ş›Á_pkt_hªdËrs.h
"

2 
	~"ş›Á.h
"

3 
	~"commÚ_hdr.h
"

4 
	~"ş›Á_wÜk.h
"

6 
	~<±h»ad.h
>

9 
	$msg_chk_ä“_hªdËr
(

10 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
,

11 cÚ¡ 
pkt_ty³
 
ty³
)

14 
numby‹s
;

16 ià(
busy_¡©e
) {

17 
numby‹s
 = 
	`pkt_£nd
(
sockfd
,

18 
MSG_FREE_NOK
, 
NULL
, 0);

20 
numby‹s
 = 
	`pkt_£nd
(
sockfd
,

21 
MSG_FREE_OK
, 
NULL
, 0);

23 ià(-1 =ğ
numby‹s
) {

24 
	`³¼Ü
("send");

27 
	}
}

30 
	$msg_sk_assign_hªdËr
(

31 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
,

32 cÚ¡ 
pkt_ty³
 
ty³
)

34 
msg_sk_assign_¶d
 *
sk_¶d
;

35 
msg_sk_»suÉ_¶d
 *
»¥_¶d
;

37 
¶d_sz
, 
numby‹s
;

38 
sum
;

40 
sk_¶d
 = (*)
·ylßd
;

43 
	`´štf
("Reûived‡ subsk. subsk_id: %d\n", 
sk_¶d
->
subsk_id
 );

44 
	`´štf
("d©a: %s\n", 
sk_¶d
->
d©a
);

46 
sum
 = 
	`do_wÜk_sum_csv
(
sk_¶d
->
d©a
);

47 
	`¦“p
(5000);

48 
¶d_sz
 = (
msg_sk_»suÉ_¶d
);

49 
»¥_¶d
 = 
	`m®loc
(
¶d_sz
);

50 
	`mem£t
(
»¥_¶d
, 0, (*resp_pld));

52 
»¥_¶d
->
¡©us
 = 
STATUS_SUCCESS
;

53 
»¥_¶d
->
subsk_id
 = 
sk_¶d
->subtask_id;

54 
»¥_¶d
->
ruÂšg_sk_id
 = 
sk_¶d
->running_task_id;

55 
»¥_¶d
->
ouut
 = 
sum
;

57 
numby‹s
 = 
	`pkt_£nd
(
sockfd
, 
MSG_TASK_RESULT
,

58 
»¥_¶d
, 
¶d_sz
);

59 
	`´štf
("Sum: %ld\n", 
sum
);

61 
	`ä“
(
»¥_¶d
);

63 
	}
}

65 *
	$ş›Á_»cv_th»ad_â
(*
t_¬gs
)

67 *
rx_bufãr
 = 
NULL
;

68 
size_t
 
rx_sz
;

69 
pkt_ty³
 
ty³
;

70 
»t
;

74 
	`debug_´št
("recv from server socket %s", "");

75 
»t
 = 
	`pkt_»cv
 (
sockfd
, &
rx_bufãr
, &
rx_sz
, &
ty³
);

76 ià(-1 =ğ
»t
 || !
rx_bufãr
) {

77 
	`³¼Ü
 ("recv");

81 
ty³
) {

82 
MSG_CHK_FREE
:

83 
	`msg_chk_ä“_hªdËr
(
rx_bufãr
, 
rx_sz
, 
ty³
);

85 
MSG_TASK_ASSIGN
:

86 
	`msg_sk_assign_hªdËr
(
rx_bufãr
, 
rx_sz
, 
ty³
);

90 
	`´štf
("\nUnexpected message!!!");

92 
	`ä“
(
rx_bufãr
);

94 
	`±h»ad_ex™
(
NULL
);

95 
	}
}

97 *
	$ş›Á_h—¹b—t_th»ad_â
(*
t_¬gs
)

101 
	`¦“p
(3);

102 
numby‹s
 = 0;

103 
buf
[
MAXBUFFER
];

104 
time_t
 
now
;

107 
buf_‹mp
[80];

109 
	`¡ráime
(
buf_‹mp
, (buf_‹mp), "%¨%Y-%m-%d %H:%M:%S %Z", &
ts
);

110 
	`debug_´št_2
("%s\n", 
buf_‹mp
);

112 
now
 = 
	`g‘_•och£cÚds_now
();

113 
	`debug_´št_2
("Epoch: %ld\n", (è
now
);

114 
	`¥rštf
(
buf
, "%ld", ()
now
);

116 
numby‹s
 = 
	`pkt_£nd
(
sockfd
, 
MSG_HEARTBEAT
, 
buf
, 
	`¡¾’
(buf));

117 ià(-1 =ğ
numby‹s
)

119 
	`³¼Ü
("send");

122 
	`±h»ad_ex™
(
NULL
);

123 
	}
}

	@client_pkt_handlers.h

1 #iâdeà
_CLIENT_PKT_HANDLERS_H


2 
	#_CLIENT_PKT_HANDLERS_H


	)

4 
	~<¡dlib.h
>

5 
	~"commÚ_hdr.h
"

8 
g‘_ava_hªdËr
(

9 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
,

10 cÚ¡ 
pkt_ty³
 
ty³
);

13 *
ş›Á_»cv_th»ad_â
(*
t_¬gs
);

15 *
ş›Á_h—¹b—t_th»ad_â
(*
t_¬gs
);

	@client_work.c

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

4 
	~"commÚ_hdr.h
"

5 
	~"ş›Á.h
"

6 
	~"ş›Á_wÜk.h
"

9 
	$do_wÜk_sum_csv
(*
csv_¡r
)

11 
size_t
 
f›ld_Ën
;

12 cÚ¡ *
s
 = 
csv_¡r
;

13 cÚ¡ 
d–ims
[] = ",";

14 
num_¡ršg
[10];

15 
sum
 = 0;

16 
num
;

19 
f›ld_Ën
 = 
	`¡rc¥n
(
s
, 
d–ims
);

21 
	`¡ºıy
(
num_¡ršg
, 
s
, 
f›ld_Ën
);

22 
num_¡ršg
[
f›ld_Ën
] = '\0';

23 
num
 = 
	`©oi
(
num_¡ršg
);

24 
sum
 +ğ
num
;

25 
	`debug_´št_2
("\Âum_¡ršg: %s,‚um: %d", 
num_¡ršg
, 
num
);

26 
	`debug_´št_3
("\"%.*s\"\n", ()
f›ld_Ën
, 
s
);

27 
s
 +ğ
f›ld_Ën
;

28 } *
s
++);

30  
sum
;

31 
	}
}

	@client_work.h

1 #iâdeà
_CLIENT_WORK_H


2 
	#_CLIENT_WORK_H


	)

4 
	~<¡dlib.h
>

5 
	~"commÚ_hdr.h
"

8 
do_wÜk_sum_csv
(*
¡ršg
);

	@common_hdr.h

1 #iâdeà
_COMMON_HDR_H


2 
	#_COMMON_HDR_H


	)

4 
	~<sys/ty³s.h
>

5 
	~<sys/sock‘.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<as£¹.h
>

9 
	~<¡dio.h
>

10 
	~<time.h
>

12 
	#NOFLAGS
 0

	)

13 
	#MAXNUMCLIENTS
 10

	)

14 
	#MAXDATASIZE
 100

	)

15 
	#MAXBUFFER
 1024*1024

	)

16 
	#MAXHOSTNAME
 48

	)

17 
	#MAXDESC
 2048

	)

18 
	#MAGIC
 0xCA0000CB

	)

19 
	#MAXDATEBUF
 25

	)

20 
	#MAXFILENAME
 25

	)

21 
	#MAXCHUNKSIZE
 1024

	)

22 
	#DEBUG
 1

	)

23 
	#DEBUG_2
 0

	)

24 
	#DEBUG_3
 0

	)

26 
	#debug_´št
(...) \

27 dØ{ ià(
DEBUG
è
	`´štf
(
__VA_ARGS__
); } 0)

	)

31 
	#debug_´št_2
(
fmt
, ...) \

32 dØ{ ià(
DEBUG_2
è
	`årštf
(
¡d”r
, "\n%s:%d:%s(): " 
fmt
, 
__FILE__
, \

33 
__LINE__
, 
__func__
, 
__VA_ARGS__
); } 0)

	)

35 
	#debug_´št_3
(
fmt
, ...) \

36 dØ{ ià(
DEBUG_3
è
	`årštf
(
¡d”r
, "\n%s:%d:%s(): " 
fmt
, 
__FILE__
, \

37 
__LINE__
, 
__func__
, 
__VA_ARGS__
); } 0)

	)

38 
	eŒuth_v®s
{

39 
	mFALSE
 = 0,

40 
	mTRUE
 = 1,

44 
	mMSG_HELLO
 = 1,

45 
	mMSG_JOIN_GRP
,

46 
	mMSG_HEARTBEAT
,

47 
	mMSG_GET_GRP_LIST_FOR_TASK
,

48 
	mMSG_GET_GRP_LIST_FOR_TASK_RESP
,

49 
	mMSG_CHK_FREE
,

50 
	mMSG_FREE_OK
,

51 
	mMSG_FREE_NOK
,

52 
	mMSG_TASK_ASSIGN
,

53 
	mMSG_TASK_RESULT
,

54 
	mMSG_QUIT
,

55 } 
	tpkt_ty³
;

58 
	mSTATUS_SUCCESS
 = 0,

59 
	mSTATUS_FAILURE
,

60 
	mSTATUS_ABORTED
,

61 } 
	t¡©us_code_t
;

65 
	smsg_još_g½_¶d
 {

66 
	mg½_id
;

70 
	smsg_chk_ä“_¶d
 {

71 
	msk_id
;

74 
	smsg_chk_ä“_»¥_¶d
 {

75 
Œuth_v®s
 
	mä“
;

78 
	smsg_sk_assign_¶d
 {

79 
	mËn
;

80 
	mruÂšg_sk_id
;

81 
	msubsk_id
;

82 
	md©a
[0];

85 
	smsg_sk_»suÉ_¶d
 {

86 
¡©us_code_t
 
	m¡©us
;

87 
	mruÂšg_sk_id
;

88 
	msubsk_id
;

89 
	mouut
;

94 
	mTASK_SUM
 = 1,

95 } 
	tsk_ty³_t
;

97 
	spkt
 {

98 
	mmagic
;

99 
pkt_ty³
 
	mty³
;

100 
size_t
 
	mËn
;

101 
	md©a
[0];

102 } 
	gPACKED
;

104 
šlše
 
	$g‘_•och£cÚds_now
()

106 
time_t
 
•och_£cÚds
, 
now
;

107 
tm
 
ts
;

109 
	`time
(&
now
);

110 
ts
 = *
	`loÿÉime
(&
now
);

111 
•och_£cÚds
 = 
	`mktime
(&
ts
);

112  
•och_£cÚds
;

113 
	}
}

115 
šlše
 
size_t
 
	$pkt_£nd
(
fd
, 
pkt_ty³
 
ty³
, *
d©a
, 
size_t
 
d©a_size
)

117 
pkt
 *
p
 = 
NULL
;

118 
size_t
 
sz
;

120 
d©a_£Á
;

121 
off£t
 = 0;

123 
sz
 = (
pkt
è+ 
d©a_size
;

124 
p
 = 
	`m®loc
(
sz
);

126 ià(!
p
) {

127 
	`³¼Ü
("Error in malloc of…acket");

128 
	`as£¹
(0);

131 
	`mem£t
(
p
, 0, 
sz
);

132 
p
->
magic
 = 
MAGIC
;

133 
p
->
ty³
 =ype;

134 
p
->
Ën
 = 
d©a_size
;

135 
	`memıy
(
p
->
d©a
, d©a, 
d©a_size
);

136 #ifdeà
LOG


137 
	`´štf
("Sending…kt size:%zu…ayload_len: %zu…ktype:%d\n",

138 
sz
, 
p
->
Ën
,…->
ty³
);

142 
d©a_£Á
 = 
	`£nd
(
fd
, (cÚ¡ *è
p
 + 
off£t
, 
sz
, 
NOFLAGS
);

143 ià(
d©a_£Á
 < 
sz
 ) {

144 
sz
 = sz - 
d©a_£Á
;

145 
off£t
 = off£ˆ+
d©a_£Á
;

151 
	`ä“
(
p
);

153  
d©a_size
;

154 
	}
}

156 
šlše
 
	$pkt_»cv
(
fd
, **
rx_buf
, 
size_t
 *
d©a_size
, 
pkt_ty³
 *
ty³
)

158 *
rx_buf
 = 
NULL
;

162 
pkt
 
dummy
;

163 
size_t
 
pkt_Ën
;

164 
size_t
 
·ylßd_Ën
;

165 
size_t
 
rcvd_by‹s
;

166 
off£t
 = 0;

168 
pkt_Ën
 = 
	`»cv
(
fd
, &
dummy
, (
pkt
), 
NOFLAGS
);

170 #ifdeà
LOG


171 
	`´štf
("Rxbytes: %zu, magic: %x…kt_type: %d,…ayload_len: %zu\n",

172 
pkt_Ën
, 
dummy
.
magic
, dummy.
ty³
, dummy.
Ën
);

175 *
ty³
 = 
dummy
.type;

176 
·ylßd_Ën
 = 
dummy
.
Ën
;

177 *
d©a_size
 = 
·ylßd_Ën
;

179 *
rx_buf
 = 
	`m®loc
(
·ylßd_Ën
);

180 ià(!
rx_buf
) {

181 
	`³¼Ü
("Error in malloc during…kt_recv");

186 
rcvd_by‹s
 = 
	`»cv
(
fd
, (*
rx_buf
è+ 
off£t
, 
·ylßd_Ën
 - off£t, 
NOFLAGS
);

188 ià(
rcvd_by‹s
 < 
·ylßd_Ën
) {

189 
off£t
 = 
·ylßd_Ën
 - 
rcvd_by‹s
;

197 
	}
}

	@common_utils.c

1 
	~<¡ršg.h
>

3 
	~"commÚ_hdr.h
"

6 
	$ut_g‘_št_li¡_äom_csv
(*
csv
, **
µ_¬r
,

7 *
Ën
)

9 *
p
 = 
csv
;

10 
couÁ
 = 0;

11 
idx
;

13 *
¬r
;

16 
couÁ
++;

18 
p
 = 
	`¡rchr
(p, ',');

19 ià(
p
 =ğ
NULL
)

22 
p
++;

26 *
Ën
 = 
couÁ
;

27 *
µ_¬r
 = 
	`m®loc
((è* 
couÁ
);

29 
¬r
 = *
µ_¬r
;

31 
p
 = 
csv
;

32 
idx
 = 0;

34 
i
 = 
	`©oi
(
p
);

35 
¬r
[
idx
] = 
i
;

37 
p
 = 
	`¡rchr
(p, ',');

38 ià(
p
 =ğ
NULL
)

40 
p
++;

41 
idx
++;

43 
	}
}

45 
	$g‘_Ãxt_chunk
(*
šput_fe_Çme
, 
off£t
,

46 *
chunk_size
,

47 *
p_¡ršg_chunk
)

50 
FILE
 *
f
;

51 
DELTA
 = 10;

52 
buf
[
MAXCHUNKSIZE
 + 1] = {'\0'};

53 
cur_Ën
;

54 
»t
 = 0;

55 
šdex
;

56 
f
 = 
	`fİ’
(
šput_fe_Çme
, "r");

57 
	`f£ek
(
f
, 
off£t
, 
SEEK_SET
);

58 
cur_Ën
 = 
	`ä—d
(
buf
, (), 
MAXCHUNKSIZE
, 
f
);

62 if(
buf
 =ğ
NULL
 || buf[0] == '\0')

64 
buf
[
cur_Ën
] = '\0';

65 
šdex
 = 
cur_Ën
 - 1;

66 
šdex
 > 0 && (
cur_Ën
 + 1è=ğ
MAXCHUNKSIZE
) {

67 ià(
buf
[
šdex
] == ',')

69 
šdex
--;

71 if(
buf
[
šdex
] == '\n') {

72 
»t
 = -1;

74 *
chunk_size
 = 
cur_Ën
 = 
šdex
;

75 
	`¡ºıy
(
p_¡ršg_chunk
, 
buf
,
cur_Ën
);

77 
	`fşo£
(
f
);

78  
»t
;

79 
	}
}

	@common_utils.h

1 
	~"commÚ_hdr.h
"

4 
ut_g‘_št_li¡_äom_csv
(*
csv
, **
µ_¬r
,

5 *
Ën
);

8 
g‘_Ãxt_chunk
(*
šput_fe_Çme
, 
off£t
,

9 *
chunk_size
,

10 **
p_¡ršg_chunk
);

	@server.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<”ºo.h
>

5 
	~<¡ršg.h
>

6 
	~<sys/ty³s.h
>

7 
	~<sys/sock‘.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<Ãtdb.h
>

10 
	~<¬·/š‘.h
>

11 
	~<sys/wa™.h
>

12 
	~<sigÇl.h
>

13 
	~<±h»ad.h
>

15 
	~"commÚ_hdr.h
"

16 
	~"£rv”.h
"

17 
	~"£rv”_db.h
"

18 
	~"£rv”_pkt_hªdËrs.h
"

23 
glob®_db
 
	gdb
;

25 
±h»ad_t
 
	g³riodic_th»ad
;

26 
±h»ad_t
 
	gu£r_š‹¿ùÜ_th»ad
;

28 
±h»ad_t
 
	gh—¹b—t_th»ad
;

29 
	g£rv”_sockfd
;

31 
š™_³riodic_´št
();

32 
š™_u£r_š‹¿ùÜ
();

33 
š™_h—¹b—t_th»ad
();

34 
š™_£rv”_sock‘
(
¬gc
, *
¬gv
[]);

35 
Ãw_cÚÃùiÚ
(
fd_£t
 *
ma¡”_fds
, *
fdmax
);

36 
hªdË_ş›Á_»cv
(
fd_£t
 *
ma¡”
, 
sock_id
);

39 
	$maš
 (
¬gc
, *
¬gv
[])

42 
i
 = 0;

43 
fd_£t
 
ma¡”
;

44 
fd_£t
 
»ad_fds
;

45 
fdmax
;

46 
»t
;

48 
	`š™_glob®_db
();

49 
»t
 = 
	`š™_£rv”_sock‘
(
¬gc
, 
¬gv
);

50 ià(0 !ğ
»t
) {

51 
	`årštf
(
¡d”r
, "unableo create socket!\n");

52 
	`ex™
(1);

56 
	`š™_³riodic_´št
();

57 
	`š™_u£r_š‹¿ùÜ
();

59 
	`š™_h—¹b—t_th»ad
();

61 
	`FD_ZERO
 (&
ma¡”
);

62 
	`FD_SET
 (
£rv”_sockfd
, &
ma¡”
);

63 
fdmax
 = 
£rv”_sockfd
;

66 
»ad_fds
 = 
ma¡”
;

67 ià(
	`£Ëù
 (
fdmax
 + 1, &
»ad_fds
,

68 
NULL
, NULL, NULL) == -1) {

69 
	`³¼Ü
 ("select");

70 
	`ex™
 (4);

72 
i
 = 0; i <ğ
fdmax
; i++) {

73 ià(
	`FD_ISSET
 (
i
, &
»ad_fds
)) {

74 ià(
i
 =ğ
£rv”_sockfd
) {

75 
	`Ãw_cÚÃùiÚ
(&
ma¡”
, &
fdmax
);

77 
	`hªdË_ş›Á_»cv
(&
ma¡”
, 
i
);

83 
	}
}

86 
	$š™_³riodic_´št
()

88 
	`±h»ad_ü—‹
 (&
³riodic_th»ad
, 
NULL
, 
³riodic_´št_th»ad_â
,

89 
NULL
);

90 
	}
}

93 
	$š™_u£r_š‹¿ùÜ
()

95 
	`±h»ad_ü—‹
 (&
u£r_š‹¿ùÜ_th»ad
, 
NULL
, 
u£r_š‹¿ùÜ_th»ad_â
,

96 
NULL
);

97 
	}
}

100 
	$š™_h—¹b—t_th»ad
()

102 
	`±h»ad_ü—‹
 (&
h—¹b—t_th»ad
, 
NULL
, 
h—¹b—t_th»ad_â
,

103 
NULL
);

104 
	}
}

107 
	$hªdË_ş›Á_»cv
(
fd_£t
 *
ma¡”
, 
sock_id
)

109 *
rx_bufãr
 = 
NULL
;

110 
size_t
 
rx_sz
;

111 
pkt_ty³
 
ty³
;

112 
»t
;

113 
ş›Á_šfo_d©a
 *
ş›Á_šfo
 = 
NULL
;

115 
	`debug_´št_2
 ("»cv fromhş›Á sock‘: %d\n", 
sock_id
);

116 
»t
 = 
	`pkt_»cv
 (
sock_id
, &
rx_bufãr
, &
rx_sz
, &
ty³
);

117 ià(-1 =ğ
»t
 || !
rx_bufãr
 || 
ty³
 =ğ
MSG_QUIT
) {

118 
	`³¼Ü
 ("recv");

119 
	`şo£
 (
sock_id
);

120 
	`FD_CLR
 (
sock_id
, 
ma¡”
);

127 ià(-1 =ğ
»t
 || !
rx_bufãr
) {

128 
	`³¼Ü
 ("recv");

129 
	`şo£
 (
sock_id
);

134 
ş›Á_šfo
 = 
	`db_g‘_ş›Á_by_sock‘
(
sock_id
);

137 
ty³
)

139 
MSG_JOIN_GRP
:

140 
	`još_hªdËr
(
ş›Á_šfo
, 
rx_bufãr
, 
rx_sz
, 
ty³
);

143 
MSG_HELLO
:

144 
	`h–lo_hªdËr
(
ş›Á_šfo
, 
rx_bufãr
, 
rx_sz
, 
ty³
);

148 
MSG_TASK_RESULT
:

149 
	`sk_»suÉ_hªdËr
(
ş›Á_šfo
, 
rx_bufãr
, 
rx_sz
, 
ty³
);

151 
MSG_HEARTBEAT
:

152 
	`h—¹b—t_hªdËr
(
ş›Á_šfo
, 
rx_bufãr
);

155 
MSG_QUIT
:

156 
	`qu™_hªdËr
(
ş›Á_šfo
);

160 
	`´štf
 ("unknown…acket!!!!");

162 
	`ä“
 (
rx_bufãr
);

164 
	}
}

168 
	$š™_£rv”_sock‘
(
¬gc
, *
¬gv
[])

170 
sockaddr_š
 
£rv”
;

171 ià(
¬gc
 != 2) {

172 
	`årštf
 (
¡d”r
, "u§ge: % <pÜt-num>\n", 
¬gv
[0]);

176 
£rv”_pÜt_num
 = 
	`©oi
 (
¬gv
[1]);

177 
£rv”_sockfd
 = 
	`sock‘
 (
AF_INET
, 
SOCK_STREAM
, 0);

178 ià(
£rv”_sockfd
 < 0)

180 
	`³¼Ü
 ("server: socket");

184 
£rv”
.
sš_çmy
 = 
AF_INET
;

185 
£rv”
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

186 
£rv”
.
sš_pÜt
 = 
	`htÚs
 (
£rv”_pÜt_num
);

187 
	`mem£t
 (&(
£rv”
.
sš_z”o
), 0,  (server.sin_zero));

189 ià(-1 =ğ
	`bšd
 (
£rv”_sockfd
, (
sockaddr
 *è&
£rv”
,

190  (
sockaddr
)))

192 
	`şo£
 (
£rv”_sockfd
);

193 
	`³¼Ü
 ("server: bind");

198 ià(-1 =ğ
	`li¡’
 (
£rv”_sockfd
, 
MAXNUMCLIENTS
))

200 
	`³¼Ü
 ("listen");

204 
	`´štf
 ("server: waiting for connections... \n");

206 
	}
}

210 
	$Ãw_cÚÃùiÚ
(
fd_£t
 *
ma¡”_fds
, *
fdmax
)

212 
Ãwfd
;

213 
sockaddr_š
 
ş›Á_addr
;

214 
sockËn_t
 
sš_size
;

216 
ş›Á_šfo_d©a
 *
d©a
;

217 
d©a
 = 
	`m®loc
((*data));

218 ià(!
d©a
) {

219 
	`³¼Ü
("new_connection: Out of memory!\n");

220 
	`ex™
(1);

223 
	`mem£t
(
d©a
, 0, (*data));

225 
sš_size
 =  (
ş›Á_addr
);

226 
Ãwfd
 = 
	`acû±
 (
£rv”_sockfd
, (
sockaddr
 *è&
ş›Á_addr
,

227 &
sš_size
);

228 ià(
Ãwfd
 == -1) {

229 
	`³¼Ü
 ("accept");

232 
	`debug_´št_3
("acû±hÃw cÚÃùiÚ from‚ewfd=%d\n",
Ãwfd
);

233 
	`FD_SET
 (
Ãwfd
, 
ma¡”_fds
);

234 ià(
Ãwfd
 > *
fdmax
) {

236 *
fdmax
 = 
Ãwfd
;

239 
d©a
->
sock‘
 = 
Ãwfd
;

240 
	`¡ºıy
(
d©a
->
ho¡Çme
, 
	`š‘_Áß
(
ş›Á_addr
.
sš_addr
),

241 
MAXHOSTNAME
);

242 
d©a
->
pkt_couÁ
 = 0;

243 
d©a
->
pÜt
 = 
	`Áohs
(
ş›Á_addr
.
sš_pÜt
);

244 
	`db_ş›Á_Ãw
(
d©a
);

245 
	`´štf
 ("\nNew client joined (%s , %d)\n",

246 
d©a
->
ho¡Çme
,

247 
d©a
->
pÜt
);

250 
	}
}

253 
	$qu™_­p
()

256 
	`´štf
("\nGracefullyƒxiting!");

257 
	`ex™
(0);

258 
	}
}

	@server.h

1 #iâdeà
_CAPS_SERVER_H


2 
	#_CAPS_SERVER_H


	)

4 
	~"commÚ_hdr.h
"

7 *
ş›Á_hªdËr
(*
t_¬gs
);

8 *
³riodic_´št_t
(*
t_¬gs
);

11 *
³riodic_´št_th»ad_â
(*
t_¬gs
);

12 *
u£r_š‹¿ùÜ_th»ad_â
(*
t_¬gs
);

14 *
h—¹b—t_th»ad_â
(*
t_¬gs
);

15 * 
ş›Á_hªdËr_th»ad
(*
t_¬gs
);

18 
sk_m’u
();

21 
qu™_­p
();

	@server_coordinator.c

1 
	~<lim™s.h
>

3 
	~"£rv”.h
"

4 
	~"£rv”_db.h
"

5 
	~"£rv”_coÜdš©Ü.h
"

8 
	gsk_couÁ”
;

10 
	$sk_¥l™
(cÚ¡ 
ruÂšg_sk
 *
¹
)

12 
FILE
 *
š_å
;

13 
size_t
 
sz
;

15 
chunk_sz
;

16 
š_å
 = 
	`fİ’
(
¹
->
šput_fe
, "r");

17 
	`f£ek
(
š_å
, 0L, 
SEEK_END
);

18 
sz
 = 
	`á–l
(
š_å
);

19 
	`´štf
("\nTÙ® fsize: %zu", 
sz
);

23 
	}
}

26 
	$£rv”_di¥©ch_sk_to_ş›Á
(

27 
ruÂšg_subsk
 *
p_subsk
,

28 
ş›Á_šfo_d©a
 *
p_ş›Á
)

30 
msg_sk_assign_¶d
 *
»q_¶d
 = 
NULL
;

31 
numby‹s
;

32 
¶d_sz
;

34 
¶d_sz
 = (
msg_sk_assign_¶d
è+ 
p_subsk
->
šput_d©a_Ën
;

35 
»q_¶d
 = 
	`m®loc
(
¶d_sz
);

36 ià(!
»q_¶d
) {

37 
	`debug_´št
("Server„an out of memory!");

38 
	`as£¹
(0);

41 
p_subsk
->
ş›Á
 = 
p_ş›Á
;

42 
p_ş›Á
->
is_busy
 = 
TRUE
;

43 
p_subsk
->
¡©us
 = 
SUBTASK_DISPATCHED
;

44 
»q_¶d
->
Ën
 = 
p_subsk
->
šput_d©a_Ën
;

45 
»q_¶d
->
subsk_id
 = 
p_subsk
->subtask_id;

46 
»q_¶d
->
ruÂšg_sk_id
 = 
p_subsk
->
·»Á_sk_id
;

48 
	`memıy
(
»q_¶d
->
d©a
, 
p_subsk
->
šput_d©a
,…_subsk->
šput_d©a_Ën
);

49 
numby‹s
 = 
	`pkt_£nd
(
p_ş›Á
->
sock‘
, 
MSG_TASK_ASSIGN
,

50 
»q_¶d
, 
¶d_sz
);

51 ià(
numby‹s
 == -1) {

52 
	`´štf
("Error in sending MSG_TASK_ASSIGN");

57 
	`´štf
("Dispatched subtask…_subtask->parent_task_id - %d,…_subtask->subtask_id - %do Client-id: %d\n",

58 
p_subsk
->
·»Á_sk_id
,

59 
p_subsk
->
subsk_id
,

60 
p_ş›Á
->
sock‘
);

62 
	`ä“
(
»q_¶d
);

64 
	}
}

67 
	$£rv”_di¡_sk_to_ş›Ás
(cÚ¡ 
g½_id
,

68  cÚ¡ 
šput_sk
 *input_task)

70 
group_šfo_node
 *
g½
;

71 
ş›Á_šfo_li¡_node
 *
ş›Á_li¡_node
;

72 
ruÂšg_sk
 *
p_run_sk
;

73 
g½_ş›Ás_couÁ
 = 0;

74 
¡©us
;

77 
	`´štf
("%s: group: %d, iÅut_fe: %s\n", 
__FUNCTION__
,

78 
g½_id
, 
šput_sk
->
šput_fe
);

80 
g½
 = 
	`db_g‘_group_by_g½_id
(
g½_id
);

81 ià(!
g½
) {

82 
	`´štf
("Invalid group!\n");

86 
sk_couÁ”
 = (sk_couÁ” + 1è% 
INT_MAX
;

87 
¡©us
 = 
	`db_sk_Ãw
(
sk_couÁ”
, 
g½_id
, 
TASK_SUM
, 
šput_sk
, &
p_run_sk
);

88 ià(
¡©us
 !ğ0 || !
p_run_sk
) {

89 
	`´štf
("Couldn't‡ssign‚ewask!");

93 
	`£rv”_sk_¥l™
(
p_run_sk
);

94 
	`db_subsks_´št
(
p_run_sk
);

95 
	`£rv”_sk_exec
(
p_run_sk
, 
g½
);

98 
	}
}

100 
	$£rv”_sk_¥l™
(
ruÂšg_sk
 *
p_¹
)

103 *
f’ame
 = 
p_¹
->
šput_fe
;

104 
buf
[
MAXCHUNKSIZE
];

105 
chunk_sz
;

106 
off£t
 = 0;

107 
»t
;

108 
i
 = 0;

111 
»t
 = 
	`g‘_Ãxt_chunk
(
f’ame
, 
off£t
, &
chunk_sz
, 
buf
);

113 
	`fæush
(
¡dout
);

114 
off£t
 +ğ
chunk_sz
;

115 
	`db_subsk_Ãw
(
i
, 
chunk_sz
, 
buf
, 
p_¹
);

116 
i
++;

117 } 
»t
 == 0);

119 
	}
}

122 
	$£rv”_sk_exec
(
ruÂšg_sk
 *
p_run_sk
,

123 
group_šfo_node
 *
g½
)

125 
»t
 = 0;

126 
ruÂšg_subsk
 *
p_subsk
 = 
p_run_sk
->
subsks_h—d
;

127 
ş›Á_šfo_li¡_node
 *
ş›Á_li¡_node
 = 
g½
->
memb”s
;

128 
ş›Á_šfo_d©a
 *
p_ş›Á
;

130 
num_³ndšg
 = 0;

133 
num_³ndšg
 = 0;

134 
p_subsk
) {

135 ià(
p_subsk
->
¡©us
 =ğ
SUBTASK_NOT_DISPATCHED
) {

136 
»t
 = 
	`g‘_ä“_ş›Á_äom_g½
(
g½
, &
p_ş›Á
);

137 ià(
»t
 != 0) {

138 
	`´štf
("Waiting for‡t†east one cliento be free.. :) \n");

142 
	`£rv”_di¥©ch_sk_to_ş›Á
(
p_subsk
, 
p_ş›Á
);

143 
num_³ndšg
++;

145 
p_subsk
 =…_subsk->
Ãxt
;

148 ià(
num_³ndšg
 == 0) {

149 
	`´štf
("AÎ Subsk com¶‘fÜ„uÂšg_sk: %d\n", 
p_run_sk
->
sk_id
);

152 
p_subsk
 = 
p_run_sk
->
subsks_h—d
;

156 
	}
}

158 
	$g‘_ä“_ş›Á_äom_g½
(
group_šfo_node
 *
g½
,

159 
ş›Á_šfo_d©a
 **
µ_ş›Á
)

161 
»t
 = -1;

162 
ş›Á_šfo_li¡_node
 *
p_ş›Á_node
;

163 
p_ş›Á_node
 = 
g½
->
memb”s
;

164 
p_ş›Á_node
) {

165 ià(!
p_ş›Á_node
->
d©a
->
is_busy
) {

166 *
µ_ş›Á
 = 
p_ş›Á_node
->
d©a
;

167 
	`´štf
("F»ş›Á: %d\n", 
p_ş›Á_node
->
d©a
->
sock‘
);

171  
»t
;

172 
	}
}

	@server_coordinator.h

1 #iâdeà
_SERVER_COORDINATOR_H


2 
	#_SERVER_COORDINATOR_H


	)

4 
	~"£rv”.h
"

7 
£rv”_di¡_sk_to_ş›Ás
(cÚ¡ 
g½_id
,

8  cÚ¡ 
šput_sk
 *
sk_šfo
);

10 
£rv”_sk_exec
(
ruÂšg_sk
 *
p_run_sk
, 
group_šfo_node
 *
g½
);

13 
£rv”_sk_¥l™
(
ruÂšg_sk
 *
p_¹
);

17 
g‘_ä“_ş›Á_äom_g½
(
group_šfo_node
 *
g½
,

18 
ş›Á_šfo_d©a
 **
µ_ş›Á
);

	@server_db.c

1 
	~"£rv”_db.h
"

3 
	~<as£¹.h
>

5 
	$š™_glob®_db
()

7 
	`mem£t
(&
db
, 0, (
glob®_db
));

8 
	`´štf
("Initializing Global DB");

9 
	}
}

11 
	$db_ş›Á_Ãw
(
ş›Á_šfo_d©a
 *
d©a
)

13 
ş›Á_šfo_li¡_node
 *
node
 = 
NULL
;

14 
ş›Á_šfo_li¡_node
 *
‹mp
;

15 
node
 = 
	`m®loc
((*node));

16 
node
->
d©a
 = data;

17 
node
->
Ãxt
 = 
NULL
;

19 ià(!
db
.
ş›Á_li¡
) {

20 
db
.
ş›Á_li¡
 = 
node
;

21 
	`debug_´št_2
("Added fœ¡ cl›ÁØş›Á_db = %p",
db
.
ş›Á_li¡
);

23 
‹mp
 = 
db
.
ş›Á_li¡
;

24 
db
.
ş›Á_li¡
 = 
node
;

25 
node
->
Ãxt
 = 
‹mp
;

26 
	`debug_´št_2
("Added oÃ mÜş›ÁØş›Á_db = %p",
db
.
ş›Á_li¡
);

29 
db
.
ş›Ás_couÁ
++;

30 
	`´štf
("TÙ®‚umb” oàş›Ás: %d\n", 
db
.
ş›Ás_couÁ
);

32 
	}
}

34 
ş›Á_šfo_d©a
 *

35 
	$db_g‘_ş›Á_by_sock‘
(
sock_id
)

38 
ş›Á_šfo_li¡_node
 *
node
 = 
NULL
;

39 ià(!
db
.
ş›Á_li¡
) {

40  
NULL
;

43 
node
 = 
db
.
ş›Á_li¡
;

45 
node
) {

46 ià(
node
->
d©a
->
sock‘
 =ğ
sock_id
) {

47  
node
->
d©a
;

49 
node
 =‚ode->
Ãxt
;

51  
NULL
;

52 
	}
}

54 
	$db_ş›Á_d–
(
ş›Á_šfo_d©a
 *
d©a
)

56 
ş›Á_šfo_li¡_node
 *
‹mp
, *
to_be_d–
;

58 ià(!
db
.
ş›Á_li¡
) {

59 
	`³¼Ü
("Nothingo delete!");

63 
‹mp
 = 
db
.
ş›Á_li¡
;emp->
Ãxt
 !ğ
NULL
;

64 
‹mp
 =emp->
Ãxt
) {

65 ià(
‹mp
->
Ãxt
->
d©a
 == data) {

66 
to_be_d–
 = 
‹mp
->
Ãxt
;

67 
‹mp
->
Ãxt
 =emp->next->next;

69 
	`ä“
(
to_be_d–
->
d©a
);

70 
	`ä“
(
to_be_d–
);

74 
	}
}

76 
	$db_group_Ãw
(
group_id
)

78 
group_šfo_node
 *
group_šfo
;

80 
group_šfo
 = 
	`m®loc
( *group_info);

81 
	`mem£t
(
group_šfo
, 0, (*group_info));

82 
group_šfo
->
g½_id
 = 
group_id
;

84 ià(!
db
.
group_li¡
) {

85 
db
.
group_li¡
 = 
group_šfo
;

90 
group_šfo
->
Ãxt
 = 
db
.
group_li¡
;

91 
db
.
group_li¡
 = 
group_šfo
;

92 
	}
}

94 
	$db_group_add_memb”
(
group_id
,

95 
ş›Á_šfo_d©a
 *
ş›Á_šfo
)

97 
group_šfo_node
 *
‹mp
;

98 
ş›Á_šfo_li¡_node
 *
ş›Á_šfo_node
;

100 
‹mp
 = 
	`db_g‘_group_by_g½_id
(
group_id
);

101 ià(!
‹mp
) {

102 
	`³¼Ü
("Unableo find group\n");

103 
	`as£¹
(0);

107 
ş›Á_šfo_node
 = 
	`m®loc
( *client_info_node);

108 
	`mem£t
(
ş›Á_šfo_node
, 0, (*client_info_node));

109 
ş›Á_šfo_node
->
d©a
 = 
ş›Á_šfo
;

110 
ş›Á_šfo_node
->
Ãxt
 = 
NULL
;

112 ià(!
‹mp
) {

113 
	`³¼Ü
("Tryingo‡dd cliento‡‚onƒxisting group!");

117 ià(!
‹mp
->
memb”s
) {

118 
‹mp
->
memb”s
 = 
ş›Á_šfo_node
;

120 
ş›Á_šfo_node
->
Ãxt
 = 
‹mp
->
memb”s
;

121 
‹mp
->
memb”s
 = 
ş›Á_šfo_node
;

124 
‹mp
->
num_memb”s
++;

127 
	}
}

129 
group_šfo_node
 *
	$db_g‘_group_by_g½_id
(
g½_id
)

131 
group_šfo_node
 *
‹mp
;

132 
‹mp
 = 
db
.
group_li¡
;

134 
‹mp
) {

135 ià(
‹mp
->
g½_id
 == grp_id)

136  
‹mp
;

137 
‹mp
 =emp->
Ãxt
;

140  
NULL
;

141 
	}
}

146 
	$db_sk_Ãw
(
sk_id
,

147 
g½_id
,

148 
sk_ty³_t
 
ty³
,

149 cÚ¡ 
šput_sk
 *
sk
,

150 
ruÂšg_sk
 **
µ_run_sk
)

152 
ruÂšg_sk
 *
Ãw
;

153 
ruÂšg_sk
 *
‹mp
;

155 
Ãw
 = 
	`db_g‘_sk_by_sk_id
(
sk_id
);

156 ià(
Ãw
) {

157 
	`³¼Ü
("Repeatedask!\n");

158 
	`as£¹
(0);

161 
Ãw
 = 
	`m®loc
((
ruÂšg_sk
));

162 ià(!
Ãw
) {

163 
	`debug_´št
("M®loøçed iÀ%s", 
__FUNCTION__
);

164 
	`as£¹
(0);

166 
	`mem£t
(
Ãw
, 0, (
ruÂšg_sk
));

168 
Ãw
->
sk_id
 =ask_id;

169 
Ãw
->
g½_id
 = grp_id;

170 
Ãw
->
¡©us
 = 
TASK_UNASSIGNED
;

171 
Ãw
->
¡¬t_time
 = 
	`g‘_•och£cÚds_now
();

172 
	`¡ºıy
(
Ãw
->
šput_fe
, 
sk
->šput_fe, 
MAXFILENAME
);

174 ià(
db
.
sk_li¡
) {

175 
‹mp
 = 
db
.
sk_li¡
;

176 
db
.
sk_li¡
 = 
Ãw
;

177 
Ãw
->
Ãxt
 = 
‹mp
;

179 
db
.
sk_li¡
 = 
Ãw
;

182 *
µ_run_sk
 = 
Ãw
;

183 
	`debug_´št
("\nCreated‚ewask. input_file: %sask_id: %d grp_id: %d",

184 
Ãw
->
šput_fe
, 
sk_id
, 
g½_id
);

187 
	}
}

189 
ruÂšg_sk
 * 
	$db_g‘_sk_by_sk_id
(
sk_id
)

191 
ruÂšg_sk
 *
‹mp
;

192 
‹mp
 = 
db
.
sk_li¡
;

194 
‹mp
) {

195 ià(
‹mp
->
sk_id
 ==ask_id)

196  
‹mp
;

197 
‹mp
 =emp->
Ãxt
;

200  
NULL
;

201 
	}
}

206 
	$db_subsk_Ãw
(
subsk_id
,

207 
šput_d©a_Ën
,

208 *
šput_d©a
,

209 
ruÂšg_sk
 *
p_run_sk
)

211 
ruÂšg_subsk
 *
Ãw
;

212 
ruÂšg_subsk
 *
‹mp
;

214 
Ãw
 = 
	`db_g‘_subsk_by_subsk_id
(
subsk_id
, 
p_run_sk
->
subsks_h—d
);

215 ià(
Ãw
) {

216 
	`³¼Ü
("Repeatedask!\n");

217 
	`as£¹
(0);

220 
Ãw
 = 
	`m®loc
((
ruÂšg_subsk
));

221 ià(!
Ãw
) {

222 
	`debug_´št
("M®loøçed iÀ%s", 
__FUNCTION__
);

223 
	`as£¹
(0);

225 
	`mem£t
(
Ãw
, 0, (
ruÂšg_subsk
));

227 
Ãw
->
·»Á_sk_id
 = 
p_run_sk
->
sk_id
;

228 
Ãw
->
subsk_id
 = subtask_id;

229 
Ãw
->
¡©us
 = 
SUBTASK_NOT_DISPATCHED
;

230 
Ãw
->
ş›Á
 = 
NULL
;

231 
Ãw
->
¡¬t_time
 = 
	`g‘_•och£cÚds_now
();

232 
Ãw
->
šput_d©a_Ën
 = input_data_len;

233 
Ãw
->
šput_d©a
 = 
	`ÿÎoc
((), 
šput_d©a_Ën
);

234 
	`¡ºıy
(
Ãw
->
šput_d©a
, iÅut_d©a, 
šput_d©a_Ën
);

235 
	`debug_´št_2
("\Âew->šput_d©a: % šput_d©¨%s", 
Ãw
->
šput_d©a
,

236 
šput_d©a
);

238 ià(
p_run_sk
->
subsks_h—d
) {

239 
‹mp
 = 
p_run_sk
->
subsks_h—d
;

240 
p_run_sk
->
subsks_h—d
 = 
Ãw
;

241 
Ãw
->
Ãxt
 = 
‹mp
;

243 
p_run_sk
->
subsks_h—d
 = 
Ãw
;

246 
	`debug_´št_2
("\nCreated‚ew subask. "

248 
Ãw
->
subsk_id
,‚ew->
·»Á_sk_id
,‚ew->
šput_d©a
);

251 
	}
}

254 
ruÂšg_subsk
 * 
	$db_g‘_subsk_by_subsk_id
(
subsk_id
,

255 
ruÂšg_subsk
 *
subsks_h—d
)

257 
ruÂšg_subsk
 *
‹mp
 = 
subsks_h—d
;

259 
‹mp
) {

260 ià(
‹mp
->
subsk_id
 == subtask_id)

261  
‹mp
;

262 
‹mp
 =emp->
Ãxt
;

265  
NULL
;

266 
	}
}

268 
	$db_subsks_´št
(
ruÂšg_sk
 *
p_run_sk
)

271 
ruÂšg_subsk
 *
‹mp
 = 
p_run_sk
->
subsks_h—d
;

272 
‹mp
) {

274 
	`debug_´št
("\nsubtask_id: %d,…arent_task_id = %d, input_data = %s",

275 
‹mp
->
subsk_id
,emp->
·»Á_sk_id
,emp->
šput_d©a
);

276 
‹mp
 =emp->
Ãxt
;

279 
	}
}

	@server_db.h

1 #iâdeà
_SERVER_DB_H


2 
	#_SERVER_DB_H


	)

5 
	~<time.h
>

6 
	~"£rv”.h
"

7 
	~"¡dboŞ.h
"

10 
glob®_db
 
db
;

12 
š™_glob®_db
();

20 
	sş›Á_šfo_d©a
 {

21 
	mšfo
[
MAXDESC
];

22 
	msock‘
;

24 
	mh—¹b—t_•och_£cÚds
;

25 
	mho¡Çme
[
MAXHOSTNAME
];

26 
	mpÜt
;

27 
	mpkt_couÁ
;

28 
boŞ
 
	mis_busy
;

29 
	mbufãr
[
MAXBUFFER
];

35 
	sş›Á_šfo_li¡_node
 {

36 
ş›Á_šfo_d©a
 *
	md©a
;

37 
ş›Á_šfo_li¡_node
 *
	mÃxt
;

44 
	sglob®_db
 {

45 
ş›Á_šfo_li¡_node
 *
	mş›Á_li¡
;

46 
group_šfo_node
 *
	mgroup_li¡
;

47 
ruÂšg_sk
 *
	msk_li¡
;

48 
	mş›Ás_couÁ
;

52 
	mTASK_UNASSIGNED
 = 1,

53 
	mTASK_ASSIGNED
,

54 
	mTASK_RUNNING
,

55 
	mTASK_ABORTED
,

56 
	mTASK_COMPLETED


57 } 
	tsk_¡©us_t
 ;

60 
	mSUBTASK_NOT_DISPATCHED
 = 1,

61 
	mSUBTASK_DISPATCHED
,

62 
	mSUBTASK_RUNNING
,

63 
	mSUBTASK_COMPLETED
,

64 
	mSUBTASK_TIMED_OUT


65 } 
	tsubsk_¡©us_t
 ;

71 
db_ş›Á_Ãw
(
ş›Á_šfo_d©a
 *
d©a
);

72 
db_ş›Á_d–
(
ş›Á_šfo_d©a
 *
d©a
);

73 
ş›Á_šfo_d©a
 *
db_g‘_ş›Á_by_sock‘
(
sock_id
);

92 
	sgroup_šfo_node
 {

93 
	mg½_id
;

94 
	mnum_memb”s
;

95 
ş›Á_šfo_li¡_node
 *
	mmemb”s
;

96 
group_šfo_node
 *
	mÃxt
;

99 
db_group_Ãw
(
group_id
);

100 
db_group_add_memb”
(
group_id
,

101 
ş›Á_šfo_d©a
 *
ş›Á_šfo
);

102 
group_šfo_node
 *
db_g‘_group_by_g½_id
(
g½_id
);

105 
	sruÂšg_subsk
 {

106 
	m·»Á_sk_id
;

107 
	msubsk_id
;

108 
subsk_¡©us_t
 
	m¡©us
;

109 
ş›Á_šfo_d©a
 *
	mş›Á
;

110 
time_t
 
	m¡¬t_time
;

111 
time_t
 
	m’d_time
;

112 
	mšput_d©a_Ën
;

113 *
	mšput_d©a
;

114 
ruÂšg_subsk
 *
	mÃxt
;

118 
	sruÂšg_sk
 {

119 
	mg½_id
;

120 
	msk_id
;

121 
sk_¡©us_t
 
	m¡©us
;

122 
sk_ty³_t
 
	msk_ty³
;

123 
	mdesc
[
MAXDESC
];

124 
time_t
 
	m¡¬t_time
;

125 
time_t
 
	m’d_time
;

126 
	mšput_fe
[
MAXFILENAME
];

127 
	mnum_ş›Ás
;

128 
ruÂšg_subsk
 *
	msubsks_h—d
;

129 
ruÂšg_sk
 *
	mÃxt
;

132 
	sšput_sk
 {

133 
	mšput_fe
[
MAXFILENAME
];

138 
db_sk_Ãw
(
sk_id
,

139 
g½_id
,

140 
sk_ty³_t
 
ty³
,

141 cÚ¡ 
šput_sk
 *
sk
,

142 
ruÂšg_sk
 **
µ_sk
);

144 
ruÂšg_sk
 * 
db_g‘_sk_by_sk_id
(
sk_id
);

148 
db_subsk_Ãw
(
subsk_id
,

149 
šput_d©a_Ën
,

150 *
šput_d©a
,

151 
ruÂšg_sk
 *
µ_run_sk
);

153 
ruÂšg_subsk
 * 
db_g‘_subsk_by_subsk_id
(
subsk_id
,

154 
ruÂšg_subsk
 *
subsks_h—d
);

157 
db_subsks_´št
(
ruÂšg_sk
 *
p_run_sk
);

	@server_pkt_handlers.c

1 
	~"£rv”.h
"

2 
	~"£rv”_db.h
"

3 
	~"£rv”_pkt_hªdËrs.h
"

6 
	~<±h»ad.h
>

7 
	~<Ãtš‘/š.h
>

9 
	$još_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

10 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
, cÚ¡ 
pkt_ty³
 
ty³
)

12 
group_šfo_node
 *
g½_šfo
;

13 cÚ¡ 
msg_još_g½_¶d
 *
još_¶d
 = 
·ylßd
;

14 
»t
;

16 
g½_id
 = 
	`Áohs
(
još_¶d
->grp_id);

17 
	`debug_´št
("Cl›Á (sock_fd:%dè»que¡ tØjoš group:\"%d\"\n", 
ş›Á_šfo
->
sock‘
,

18 
g½_id
);

20 
g½_šfo
 = 
	`db_g‘_group_by_g½_id
(
g½_id
);

21 ià(!
g½_šfo
) {

22 
	`debug_´št
("C»©šg grou°%d...\n", 
g½_id
);

23 
	`db_group_Ãw
(
g½_id
);

26 
»t
 = 
	`db_group_add_memb”
(
g½_id
, 
ş›Á_šfo
);

28 ià(
»t
 != 0) {

29 
	`³¼Ü
("Error in‡dding membero group!");

32 
	}
}

33 
	$h–lo_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

34 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
, cÚ¡ 
pkt_ty³
 
ty³
)

36 
	`¡ºÿt
(
ş›Á_šfo
->
bufãr
, 
·ylßd
, 
pyld_size
);

37 
	`¡rÿt
(
ş›Á_šfo
->
bufãr
, ", ");

38 
	}
}

41 
	$sk_»suÉ_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

42 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
, cÚ¡ 
pkt_ty³
 
ty³
)

45 
msg_sk_»suÉ_¶d
 *
»¥_¶d
;

46 
»¥_¶d
 = (*è
·ylßd
;

48 
	`´štf
("Received„esponse forask_id: %d, subtask_id: %d"

50 
»¥_¶d
->
ruÂšg_sk_id
,

51 
»¥_¶d
->
subsk_id
,

52 
ş›Á_šfo
->
sock‘
,

53 
»¥_¶d
->
¡©us
,

54 
»¥_¶d
->
ouut
);

56 
ş›Á_šfo
->
is_busy
 = 
FALSE
;

58 
	}
}

62 
	$h—¹b—t_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

63 cÚ¡ *
·ylßd
)

66 
ş›Á_šfo
->
h—¹b—t_•och_£cÚds
 = (è
	`©oi
(
·ylßd
);

67 
	`debug_´št_2
("ş›Á_sock‘ = %d, h—¹b—ˆğ%ld \n",
ş›Á_šfo
->
sock‘
, cl›Á_šfo->
h—¹b—t_•och_£cÚds
);

78 
	}
}

80 
	$qu™_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
)

82 
	}
}

	@server_pkt_handlers.h

1 #iâdeà
_SERVER_PKT_HANDLERS_H


2 
	#_SERVER_PKT_HANDLERS_H


	)

5 
	~"£rv”_db.h
"

8 
još_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

9 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
,

10 cÚ¡ 
pkt_ty³
 
ty³
);

12 
h–lo_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

13 cÚ¡ *
·ylßd
, cÚ¡ 
size_t
 
pyld_size
,

14 cÚ¡ 
pkt_ty³
 
ty³
);

17 
h—¹b—t_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
,

18 cÚ¡ *
·ylßd
);

20 
qu™_hªdËr
(
ş›Á_šfo_d©a
 *
ş›Á_šfo
);

	@server_tasks.c

1 
	~<¡dio.h
>

2 
	~<fú.h
>

3 
	~<sys/¡©.h
>

4 
	~<¡ršg.h
>

6 
	~"£rv”.h
"

7 
	~"£rv”_db.h
"

8 
	~"£rv”_coÜdš©Ü.h
"

14 
	$fe_exi¡s
 (cÚ¡ *
f’ame
)

16 
¡©
 
bufãr
;

17  (
	`¡©
 (
f’ame
, &
bufãr
) == 0);

18 
	}
}

21 
	$run_sk_sum_csv
()

23 
šput_sk
 
sk
;

24 
ş›Á_šfo_li¡_node
 *
ş›Á_li¡_node
;

25 
group_šfo_node
 *
g½
;

26 
cho£n_g½_id
;

28 
	`¡ºıy
(
sk
.
šput_fe
, "./§m¶e.csv", 
MAXFILENAME
);

30 
	`´štf
("\nIÅuˆfe: %s", 
sk
.
šput_fe
);

32 ià(!
	`fe_exi¡s
(
sk
.
šput_fe
)) {

33 
	`årštf
(
¡d”r
, "\nInput file doesn'tƒxist!!");

38 
	`´štf
("\nChoose‡ worker-group fromhe following:\n");

40 
g½
 = 
db
.
group_li¡
;

41 
g½
) {

42 
	`´štf
("%d, ", 
g½
->
g½_id
);

43 
g½
 = g½->
Ãxt
;

45 
	`´štf
("\n");

46 
	`sÿnf
("%d", &
cho£n_g½_id
);

48 
	`£rv”_di¡_sk_to_ş›Ás
(
cho£n_g½_id
, &
sk
);

49 
	}
}

52 
	$exec_choiû
(
choiû
)

54 
choiû
) {

56 
	`run_sk_sum_csv
();

59 
	`qu™_­p
();

62 
	`´štf
("\nInvalid choice!");

64 
	}
}

67 
	$sk_m’u
()

69 
choiû
;

70 
	`´štf
("\n=========TASK MENU============\n");

71 
	`´štf
("\n1. Run Task: Findhe sum of‚umbers in‡ csv file");

72 
	`´štf
("\n2. Quit App");

73 
	`´štf
("\nPlease choose‡n option fromhe‡bove:\n");

74 
	`sÿnf
("%d", &
choiû
);

75 
	`exec_choiû
(
choiû
);

77 
	`´štf
("\n=============xxx==============\n");

79 
	}
}

	@server_threads.c

1 
	~<±h»ad.h
>

2 
	~<uni¡d.h
>

3 
	~<time.h
>

4 
	~<¡dio.h
>

5 
	~"commÚ_hdr.h
"

6 
	~"£rv”.h
"

7 
	~"£rv”_db.h
"

9 
	$´št_g½s_šfo
()

11 
tm
 *
tm_šfo
;

12 
time_t
 
tim”
;

13 
time_buf
[
MAXDATEBUF
];

14 
group_šfo_node
 *
g½_node
 = 
db
.
group_li¡
;

15 
ş›Á_šfo_li¡_node
 *
ş_node
;

17 
	`time
(&
tim”
);

18 
tm_šfo
 = 
	`loÿÉime
(&
tim”
);

19 
	`¡ráime
(
time_buf
, 
MAXDATEBUF
, "%Y-%m-%d %H:%M:%S", 
tm_šfo
);

21 
g½_node
) {

23 
	`´štf
("\n[%s]:G½ %d, Memb”s:", 
time_buf
, 
g½_node
->
g½_id
);

24 
ş_node
 = 
g½_node
->
memb”s
;

26 
ş_node
) {

27 
	`´štf
("%d, ", 
ş_node
->
d©a
->
sock‘
);

28 
ş_node
 = cl_node->
Ãxt
;

31 
g½_node
 = g½_node->
Ãxt
;

34 
	`fæush
(
¡dout
);

36 
	}
}

38 
	$´št_ş›Ás_šfo
()

40 
tm
 *
tm_šfo
;

41 
time_t
 
tim”
;

42 
time_buf
[
MAXDATEBUF
];

43 
ş›Á_šfo_li¡_node
 *
node
;

45 
node
 = 
db
.
ş›Á_li¡
;

46 
	`time
(&
tim”
);

47 
tm_šfo
 = 
	`loÿÉime
(&
tim”
);

48 
	`¡ráime
(
time_buf
, 
MAXDATEBUF
, "%Y-%m-%d %H:%M:%S", 
tm_šfo
);

50 
node
)

55 ià(
	`¡¾’
(
node
->
d©a
->
bufãr
) <= 1) {

56 
node
 =‚ode->
Ãxt
;

61 
	`debug_´št
("[%s] Client (%s,%d):†ast-hb:[%ld] buffer:[%s]\n",

62 
time_buf
,

63 
node
->
d©a
->
ho¡Çme
,

64 
node
->
d©a
->
pÜt
,

65 
node
->
d©a
->
h—¹b—t_•och_£cÚds
,

66 
node
->
d©a
->
bufãr
);

67 
node
 =‚ode->
Ãxt
;

70 
	}
}

73 *
	$³riodic_´št_th»ad_â
(*
t_¬gs
)

77 
	`¦“p
(60);

78 
	`debug_´št
("\nPrinting global client info\n");

79 
	`´št_ş›Ás_šfo
();

80 
	`debug_´št
("\nPrinting group %s", "status");

81 
	`´št_g½s_šfo
();

84 
	`±h»ad_ex™
(
NULL
);

86 
	}
}

89 *
	$u£r_š‹¿ùÜ_th»ad_â
(*
t_¬gs
)

92 
	`sk_m’u
();

94 
	`±h»ad_ex™
(
NULL
);

95 
	}
}

98 *
	$h—¹b—t_th»ad_â
(*
t_¬gs
)

106 
	`¦“p
(30);

107 
	`debug_´št_3
("runninghe heartbeat %s\n","thread");

108 
ş›Á_šfo_li¡_node
 *
node
;

109 
node
 = 
db
.
ş›Á_li¡
;

110 
time_t
 
now
;

112 
now
 = 
	`g‘_•och£cÚds_now
();

113 
	`debug_´št_2
("loÿÉimğ%ld\n",
now
);

114 
node
)

116 if(60 - (
now
 - 
node
->
d©a
->
h—¹b—t_•och_£cÚds
) <= 0)

118 
	`debug_´št
("cha™ªy¨: cl›Á id = %d, i nÙ s’dšg h—¹b—t\n",
node
->
d©a
->
sock‘
);

120 
node
 =‚ode->
Ãxt
;

123 
	}
}

	@
1
.
0
19
293
client.c
client.h
client_pkt_handlers.c
client_pkt_handlers.h
client_work.c
client_work.h
common_hdr.h
common_utils.c
common_utils.h
server.c
server.h
server_coordinator.c
server_coordinator.h
server_db.c
server_db.h
server_pkt_handlers.c
server_pkt_handlers.h
server_tasks.c
server_threads.c
